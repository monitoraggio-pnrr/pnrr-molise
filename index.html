<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PNRR Molise ‚Äî Dashboard Monitoraggio</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="data.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
:root{--bg:#0a0e1a;--s:#111827;--s2:#1a2236;--bd:#1e293b;--t:#e2e8f0;--dim:#94a3b8;--acc:#3b82f6;--grn:#10b981;--amb:#f59e0b;--red:#ef4444;--pur:#8b5cf6;--cya:#06b6d4}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--t);min-height:100vh}
.hdr{background:linear-gradient(135deg,#0f172a 0%,#1e1b4b 50%,#0f172a 100%);border-bottom:1px solid var(--bd);padding:.8rem 2rem;position:sticky;top:0;z-index:100}
.hdr-in{max-width:1600px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap}
.hdr-logos{display:flex;align-items:center;gap:1rem}
.hdr-logos img{height:40px;object-fit:contain}
.hdr h1{font-size:1.25rem;font-weight:700;color:#fff;letter-spacing:-.02em}
.hdr .sub{font-size:.7rem;color:var(--dim);margin-top:2px}
.hdr-r{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
.bdg{padding:.25rem .7rem;border-radius:20px;font-size:.68rem;font-weight:600;border:1px solid}
.bdg-b{background:rgba(59,130,246,.12);color:var(--acc);border-color:rgba(59,130,246,.3)}
.bdg-r{background:rgba(239,68,68,.12);color:var(--red);border-color:rgba(239,68,68,.3)}
.ct{max-width:1600px;margin:0 auto;padding:1.5rem 2rem}
.kg{display:grid;grid-template-columns:repeat(auto-fit,minmax(185px,1fr));gap:.7rem;margin-bottom:1.2rem}
.kc{background:var(--s);border:1px solid var(--bd);border-radius:10px;padding:.9rem;position:relative;overflow:hidden;transition:transform .2s}
.kc:hover{transform:translateY(-2px)}.kc::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--ca,var(--acc))}
.kl{font-size:.66rem;text-transform:uppercase;letter-spacing:.08em;color:var(--dim);font-weight:600;margin-bottom:.3rem}
.kv{font-family:'JetBrains Mono',monospace;font-size:1.35rem;font-weight:700;line-height:1}
.ks{font-size:.63rem;color:var(--dim);margin-top:.25rem}
.tabs{display:flex;gap:0;margin-bottom:1rem;border-bottom:1px solid var(--bd);overflow-x:auto}
.tab{padding:.65rem 1.1rem;font-size:.76rem;font-weight:600;color:var(--dim);cursor:pointer;border:none;border-bottom:2px solid transparent;background:none;font-family:inherit;white-space:nowrap;transition:all .2s}
.tab:hover{color:var(--t)}.tab.active{color:var(--acc);border-bottom-color:var(--acc)}
.tp{display:none}.tp.active{display:block}
.cg{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.2rem}
.cc{background:var(--s);border:1px solid var(--bd);border-radius:10px;padding:1rem}
.cc.full{grid-column:1/-1}
.ct2{font-size:.76rem;font-weight:600;margin-bottom:.7rem}
.cb{position:relative;width:100%;height:300px}.cb.tall{height:400px}.cb.xt{height:500px}
.tw{overflow-x:auto;border-radius:10px;border:1px solid var(--bd)}
table{width:100%;border-collapse:collapse;font-size:.73rem}
thead th{background:var(--s2);padding:.6rem .5rem;text-align:left;font-weight:600;color:var(--dim);text-transform:uppercase;letter-spacing:.04em;font-size:.63rem;position:sticky;top:0;cursor:pointer;user-select:none;border-bottom:1px solid var(--bd);white-space:nowrap}
thead th:hover{color:var(--acc)}th.sa::after{content:' ‚ñ≤';color:var(--acc)}th.sd::after{content:' ‚ñº';color:var(--acc)}
tbody td{padding:.45rem .5rem;border-bottom:1px solid var(--bd)}tbody tr:hover{background:rgba(59,130,246,.05)}
.mo{font-family:'JetBrains Mono',monospace;font-size:.68rem}
.pb{width:65px;height:5px;background:var(--s2);border-radius:3px;overflow:hidden;display:inline-block;vertical-align:middle;margin-right:4px}
.pf{height:100%;border-radius:3px}
.fl{display:flex;gap:.5rem;margin-bottom:.8rem;flex-wrap:wrap;align-items:center}
.fb{background:var(--s);border:1px solid var(--bd);color:var(--dim);padding:.3rem .7rem;border-radius:16px;font-size:.7rem;font-weight:500;cursor:pointer;font-family:inherit;transition:all .2s}
.fb:hover,.fb.active{background:rgba(59,130,246,.15);border-color:var(--acc);color:var(--acc)}
.si{background:var(--s);border:1px solid var(--bd);color:var(--t);padding:.35rem .7rem;border-radius:8px;font-size:.73rem;font-family:inherit;width:240px;outline:none}
.si:focus{border-color:var(--acc)}.si::placeholder{color:var(--dim)}
select.fs{background:var(--s);border:1px solid var(--bd);color:var(--t);padding:.3rem .5rem;border-radius:8px;font-size:.7rem;font-family:inherit;outline:none}
.ad{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px}
.ad.CRITICO{background:var(--red)}.ad.ATTENZIONE{background:var(--amb)}.ad.OK{background:var(--grn)}
.ab{padding:.7rem 1rem;border-radius:8px;margin-bottom:.7rem;font-size:.76rem}
.ab.red{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#fca5a5}
.ab.amber{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);color:#fcd34d}
#map{height:500px;border-radius:10px;border:1px solid var(--bd)}
.st{font-size:.88rem;font-weight:700;margin:1rem 0 .7rem;padding-left:.7rem;border-left:3px solid var(--acc)}
@media(max-width:768px){.cg{grid-template-columns:1fr}.kg{grid-template-columns:repeat(2,1fr)}.ct{padding:1rem}.hdr{padding:.7rem 1rem}.si{width:100%}}
</style>
</head>
<body>
<div class="hdr"><div class="hdr-in">
<div class="hdr-logos" id="hdr-logos">
<div><h1>PNRR Regione Molise</h1><div class="sub">Dashboard Monitoraggio Interventi ‚Äî Dati ReGiS</div></div>
</div>
<div class="hdr-r">
<span class="bdg bdg-b" id="bi"></span>
<span class="bdg bdg-r" id="ba"></span>
</div>
</div></div>

<div class="ct">
<div class="kg" id="kpi-g"></div>
<div class="tabs" id="tabs">
<button class="tab active" data-t="overview">Panoramica</button>
<button class="tab" data-t="fonti">Fonti Finanziamento</button>
<button class="tab" data-t="misure">Misure</button>
<button class="tab" data-t="esecuzione">Stato Esecuzione</button>
<button class="tab" data-t="alert">Alert</button>
<button class="tab" data-t="trend">Trend Pagamenti CUP</button>
<button class="tab" data-t="indicatori">Indicatori</button>
<button class="tab" data-t="mappa">Mappa Molise</button>
<button class="tab" data-t="rup">RUP</button>
<button class="tab" data-t="progetti">Tutti i Progetti</button>
</div>

<!-- PANORAMICA -->
<div class="tp active" id="tab-overview"><div class="cg">
<div class="cc full"><div class="ct2">Pagamenti Trimestrali e Cumulati</div><div class="cb tall"><canvas id="c-pag"></canvas></div></div>
<div class="cc"><div class="ct2">Budget per Missione</div><div class="cb"><canvas id="c-mp"></canvas></div></div>
<div class="cc"><div class="ct2">Budget per Misura (top)</div><div class="cb"><canvas id="c-mip"></canvas></div></div>
<div class="cc"><div class="ct2">Budget vs Pagamenti per Missione</div><div class="cb"><canvas id="c-mb"></canvas></div></div>
<div class="cc"><div class="ct2">Avanzamento % per Missione</div><div class="cb"><canvas id="c-ma"></canvas></div></div>
</div></div>

<!-- FONTI -->
<div class="tp" id="tab-fonti"><div class="cg">
<div class="cc"><div class="ct2">Ripartizione Fonti (globale)</div><div class="cb"><canvas id="c-fg"></canvas></div></div>
<div class="cc"><div class="ct2">Fonti per Missione (stacked)</div><div class="cb tall"><canvas id="c-fm"></canvas></div></div>
<div class="cc full"><div class="ct2">Fonti per Misura (stacked)</div><div class="cb xt"><canvas id="c-fmi"></canvas></div></div>
</div>
<div class="st">Dettaglio Fonti di Finanziamento</div>
<div class="tw"><table id="t-fonti"><thead><tr><th>Fonte</th><th>Importo</th><th>N. CUP</th><th>% su Totale</th></tr></thead><tbody></tbody></table></div>
</div>

<!-- MISURE -->
<div class="tp" id="tab-misure"><div class="cg">
<div class="cc full"><div class="ct2">Budget vs Pagamenti per Misura</div><div class="cb tall"><canvas id="c-misb"></canvas></div></div>
<div class="cc full"><div class="ct2">Avanzamento % per Misura</div><div class="cb xt"><canvas id="c-misa"></canvas></div></div>
<div class="cc full"><div class="ct2">Stato Fasi Procedurali per Misura</div><div class="cb tall"><canvas id="c-iter"></canvas></div></div>
</div></div>

<!-- ESECUZIONE -->
<div class="tp" id="tab-esecuzione">
<div class="st">Fase di Esecuzione per CUP ‚Äî Inizio e Fine Esecuzione</div>
<div class="cg">
<div class="cc"><div class="ct2">Stato Esecuzione (globale)</div><div class="cb"><canvas id="c-ep"></canvas></div></div>
<div class="cc"><div class="ct2">Esecuzione per Misura</div><div class="cb tall"><canvas id="c-em"></canvas></div></div>
</div>
<div class="fl">
<select class="fs" id="fe-mis"><option value="all">Tutte le Misure</option></select>
<select class="fs" id="fe-st"><option value="all">Tutti gli stati</option><option value="IN_RITARDO">In Ritardo</option><option value="IN_CORSO">In Corso</option><option value="NON_AVVIATA">Non Avviata</option><option value="COMPLETATA">Completata</option><option value="COMPLETATA_RITARDO">Compl. in Ritardo</option></select>
</div>
<div class="tw" style="max-height:500px;overflow-y:auto"><table id="t-exec"><thead><tr>
<th data-s="stato">Stato</th><th data-s="cup">CUP</th><th data-s="misura">Misura</th><th data-s="titolo_intervento">Titolo</th><th data-s="rup">RUP</th>
<th data-s="data_inizio_eff">Inizio Esec.</th><th data-s="data_fine_prev">Fine Prevista</th><th data-s="data_fine_eff">Fine Effettiva</th><th data-s="ritardo_giorni">Ritardo gg</th>
</tr></thead><tbody></tbody></table></div>
</div>

<!-- ALERT -->
<div class="tp" id="tab-alert">
<div id="ab"></div>
<div class="cg"><div class="cc full"><div class="ct2">Alert per Misura</div><div class="cb"><canvas id="c-am"></canvas></div></div></div>
<div class="st">CUP con Alert</div>
<div class="tw" style="max-height:500px;overflow-y:auto"><table id="t-alert"><thead><tr>
<th data-s="alert_level">Alert</th><th data-s="cup">CUP</th><th data-s="misura">Misura</th><th data-s="titolo_intervento">Titolo</th>
<th data-s="budget">Budget</th><th data-s="avanzamento_pct">Avanz.</th><th data-s="esecuzione_fine_prev">Scadenza Esec.</th>
</tr></thead><tbody></tbody></table></div>
</div>

<!-- TREND -->
<div class="tp" id="tab-trend">
<div class="st">Trend Pagamenti per CUP</div>
<div class="fl">
<select class="fs" id="tr-mis"><option value="">‚Äî Seleziona Misura ‚Äî</option></select>
<select class="fs" id="tr-cup"><option value="">‚Äî Tutti i CUP ‚Äî</option></select>
</div>
<div class="cg"><div class="cc full"><div class="ct2" id="tr-title">Seleziona una misura</div><div class="cb tall"><canvas id="c-tr"></canvas></div></div></div>
</div>

<!-- INDICATORI -->
<div class="tp" id="tab-indicatori"><div class="cg">
<div class="cc full"><div class="ct2">Target Programmati vs Realizzati</div><div class="cb tall"><canvas id="c-ind"></canvas></div></div>
</div>
<div class="st">Dettaglio Indicatori</div>
<div class="tw" style="max-height:500px;overflow-y:auto"><table id="t-ind"><thead><tr>
<th data-s="misura">Misura</th><th data-s="indicatore">Indicatore</th><th data-s="unita_misura">Unit√†</th><th data-s="tot_programmato">Programmato</th><th data-s="tot_realizzato">Realizzato</th><th data-s="pct_raggiungimento">%</th>
</tr></thead><tbody></tbody></table></div>
</div>

<!-- MAPPA -->
<div class="tp" id="tab-mappa">
<div class="st">Numerosit√† Interventi per Localizzazione</div>
<div class="fl"><button class="fb active" data-mf="all">Tutti</button><button class="fb" data-mf="CRITICO">Solo Critici</button></div>
<div id="map"></div>
</div>

<!-- RUP -->
<div class="tp" id="tab-rup">
<div class="st">Responsabili Unici del Procedimento</div>
<div class="tw"><table id="t-rup"><thead><tr>
<th data-s="rup">RUP</th><th data-s="n_cup">N. CUP</th><th data-s="budget">Budget</th><th data-s="pagamenti">Pagamenti</th><th data-s="avanz">Avanzamento</th><th data-s="n_critici">Critici</th>
</tr></thead><tbody></tbody></table></div>
</div>

<!-- PROGETTI -->
<div class="tp" id="tab-progetti">
<div class="fl">
<input type="text" class="si" id="src" placeholder="Cerca CUP, misura, titolo, RUP...">
<select class="fs" id="f-miss"><option value="all">Tutte le Missioni</option></select>
<select class="fs" id="f-rup"><option value="all">Tutti i RUP</option></select>
<select class="fs" id="f-al"><option value="all">Tutti gli Alert</option><option value="CRITICO">Critici</option><option value="ATTENZIONE">Attenzione</option><option value="OK">OK</option></select>
</div>
<div class="tw" style="max-height:600px;overflow-y:auto"><table id="t-proj"><thead><tr>
<th data-s="alert_level">‚ö†</th><th data-s="cup">CUP</th><th data-s="misura">Misura</th><th data-s="titolo_intervento">Titolo</th><th data-s="rup">RUP</th>
<th data-s="budget">Budget</th><th data-s="pagato">Pagam.</th><th data-s="avanzamento_pct">%Avanz.</th><th data-s="esecuzione_stato">Esecuz.</th><th data-s="area">Area</th>
</tr></thead><tbody></tbody></table></div>
</div>

</div>

<script>
const D=PNRR_DATA;
const fmt=n=>n==null?'‚Äî':'‚Ç¨'+Number(n).toLocaleString('it-IT',{minimumFractionDigits:0,maximumFractionDigits:0});
const fM=n=>{if(n==null)return'‚Äî';const a=Math.abs(n);if(a>=1e6)return'‚Ç¨'+(n/1e6).toFixed(1)+'M';if(a>=1e3)return'‚Ç¨'+(n/1e3).toFixed(0)+'K';return fmt(n)};
const pct=n=>n==null?'‚Äî':Number(n).toFixed(1)+'%';
const pC=v=>v>=75?'#10b981':v>=50?'#f59e0b':v>=25?'#f97316':'#ef4444';
const MC={M1:'#3b82f6',M2:'#10b981',M3:'#f59e0b',M4:'#8b5cf6',M5:'#06b6d4',M6:'#ec4899'};
const FC={'RRF-Recovery Fund':'#3b82f6','FOI-Fondo Opere Indifferibili':'#f59e0b','FPREG-Fondi Propri Regioni':'#8b5cf6','PRIV-Risorse dei Privati':'#06b6d4','ALTRO_NAZ-Altro Tipo di Finanziamento Nazionale':'#ec4899','FPOP-Fondo Prosecuzione Opere Pubbliche':'#f97316'};
const mC=['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#ec4899','#f97316','#14b8a6','#6366f1','#84cc16','#a855f7','#eab308','#0ea5e9','#d946ef','#fb923c','#22d3ee','#c084fc'];
const SC={COMPLETATA:'#10b981',IN_CORSO:'#3b82f6',IN_RITARDO:'#ef4444',NON_AVVIATA:'#475569',COMPLETATA_RITARDO:'#f59e0b'};
const fS=f=>{if(!f)return'‚Äî';const p=f.indexOf('-');return p>0?f.substring(0,p):f.substring(0,15)};

// Logos
(function(){
    const h=document.getElementById('hdr-logos');
    const L=D.logos||{};
    if(L.molise){const i=document.createElement('img');i.src='data:image/png;base64,'+L.molise;i.alt='Regione Molise';i.style.height='42px';h.insertBefore(i,h.firstChild);}
    if(L.italia_domani){const i=document.createElement('img');i.src='data:image/png;base64,'+L.italia_domani;i.alt='Italia Domani';h.appendChild(i);}
    if(L.eu){const i=document.createElement('img');i.src='data:image/png;base64,'+L.eu;i.alt='Finanziato UE';h.appendChild(i);}
})();

// Sortable helper
function mkSort(tid,dataFn,renderFn){
    let col=null,dir=-1;const t=document.getElementById(tid);if(!t)return;
    t.querySelectorAll('th[data-s]').forEach(th=>th.addEventListener('click',()=>{
        t.querySelectorAll('th').forEach(x=>x.classList.remove('sa','sd'));
        if(col===th.dataset.s)dir*=-1;else{col=th.dataset.s;dir=-1;}
        th.classList.add(dir===1?'sa':'sd');
        const d=dataFn();d.sort((a,b)=>{let va=a[col],vb=b[col];if(va==null)va='';if(vb==null)vb='';if(typeof va==='string'&&typeof vb==='string')return dir*va.localeCompare(vb);return dir*((+va||0)-(+vb||0));});
        renderFn(d);
    }));
}

// Badge
document.getElementById('bi').textContent=D.kpi.n_cup+' CUP ‚Ä¢ '+D.kpi.n_misure+' Misure ‚Ä¢ Agg. '+(D.kpi.data_aggiornamento||'');
document.getElementById('ba').textContent='‚ö† '+(D.kpi.n_critici||0)+' critici ‚Ä¢ '+(D.kpi.n_attenzione||0)+' attenz.';

// KPI
document.getElementById('kpi-g').innerHTML=[
    {l:'Budget Totale',v:fmt(D.kpi.budget_totale),s:'di cui RRF: '+fM(D.kpi.budget_rrf),a:'#3b82f6'},
    {l:'Pagamenti',v:fmt(D.kpi.totale_pagamenti),s:D.kpi.n_pagamenti+' mandati',a:'#10b981'},
    {l:'Rendicontato',v:fM(D.kpi.rendicontato),s:'Approvato: '+fM(D.kpi.rendicontato_approvato),a:'#8b5cf6'},
    {l:'Avanzamento',v:pct(D.kpi.avanzamento),s:'Pagamenti / Budget',a:D.kpi.avanzamento>=50?'#10b981':'#f59e0b'},
    {l:'N. Progetti',v:D.kpi.n_cup,s:D.kpi.n_misure+' misure ‚Ä¢ '+D.kpi.n_missioni+' missioni',a:'#06b6d4'},
    {l:'Esec. in Ritardo',v:D.kpi.n_esecuzione_ritardo||0,s:(D.kpi.n_critici||0)+' CUP critici',a:'#ef4444'},
].map(k=>`<div class="kc" style="--ca:${k.a}"><div class="kl">${k.l}</div><div class="kv">${k.v}</div><div class="ks">${k.s}</div></div>`).join('');

// Tabs
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.tp').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');document.getElementById('tab-'+t.dataset.t).classList.add('active');
    if(t.dataset.t==='mappa')setTimeout(initMap,100);
}));

// Chart defaults
Chart.defaults.color='#94a3b8';Chart.defaults.borderColor='#1e293b';Chart.defaults.font.family="'DM Sans',sans-serif";Chart.defaults.font.size=11;
Chart.defaults.plugins.legend.labels.usePointStyle=true;Chart.defaults.plugins.legend.labels.pointStyleWidth=8;
const ttCb={callbacks:{label:c=>c.dataset.label+': '+fmt(c.raw)}};

// ‚ïê‚ïê‚ïê PANORAMICA ‚ïê‚ïê‚ïê
if(D.pagamenti_cumulati&&D.pagamenti_cumulati.length)
new Chart(document.getElementById('c-pag'),{type:'bar',data:{labels:D.pagamenti_cumulati.map(p=>p.trimestre),datasets:[
{label:'Trimestrali',data:D.pagamenti_cumulati.map(p=>p.importo),backgroundColor:'rgba(59,130,246,.6)',borderRadius:4,order:2,yAxisID:'y'},
{label:'Cumulato',data:D.pagamenti_cumulati.map(p=>p.cumulato),type:'line',borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.1)',fill:true,tension:.3,pointRadius:3,borderWidth:2,order:1,yAxisID:'y1'}
]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},scales:{y:{position:'left',ticks:{callback:v=>fM(v)},grid:{color:'#1e293b44'}},y1:{position:'right',ticks:{callback:v=>fM(v)},grid:{drawOnChartArea:false}},x:{grid:{display:false}}},plugins:{tooltip:ttCb}}});

if(D.missioni&&D.missioni.length){
new Chart(document.getElementById('c-mp'),{type:'doughnut',data:{labels:D.missioni.map(m=>m.missione+' ('+fM(m.budget_totale)+')'),datasets:[{data:D.missioni.map(m=>m.budget_totale),backgroundColor:D.missioni.map(m=>MC[m.missione]||'#6366f1'),borderWidth:0,hoverOffset:8}]},options:{responsive:true,maintainAspectRatio:false,cutout:'60%'}});
new Chart(document.getElementById('c-mb'),{type:'bar',data:{labels:D.missioni.map(m=>m.missione),datasets:[
{label:'Budget',data:D.missioni.map(m=>m.budget_totale),backgroundColor:'rgba(59,130,246,.3)',borderColor:'#3b82f6',borderWidth:1,borderRadius:4},
{label:'Pagamenti',data:D.missioni.map(m=>m.totale_pagamenti),backgroundColor:'rgba(16,185,129,.5)',borderColor:'#10b981',borderWidth:1,borderRadius:4}
]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',scales:{x:{ticks:{callback:v=>fM(v)},grid:{color:'#1e293b44'}},y:{grid:{display:false}}},plugins:{tooltip:ttCb}}});
new Chart(document.getElementById('c-ma'),{type:'bar',data:{labels:D.missioni.map(m=>m.missione),datasets:[{label:'%',data:D.missioni.map(m=>m.avanzamento_pct),backgroundColor:D.missioni.map(m=>pC(m.avanzamento_pct)+'99'),borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{max:100,ticks:{callback:v=>v+'%'},grid:{color:'#1e293b44'}},y:{grid:{display:false}}},plugins:{legend:{display:false}}}});
}
if(D.misure&&D.misure.length){const top=D.misure.filter(m=>m.budget_totale>0).slice(0,15);
new Chart(document.getElementById('c-mip'),{type:'doughnut',data:{labels:top.map(m=>m.misura),datasets:[{data:top.map(m=>m.budget_totale),backgroundColor:mC.slice(0,top.length),borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'55%',plugins:{legend:{position:'right',labels:{font:{size:9}}}}}});}

// ‚ïê‚ïê‚ïê FONTI ‚ïê‚ïê‚ïê
if(D.fonti_globali&&D.fonti_globali.length){
const tB=D.kpi.budget_totale||1;
new Chart(document.getElementById('c-fg'),{type:'doughnut',data:{labels:D.fonti_globali.map(f=>fS(f.fondo)+' ('+fM(f.importo)+')'),datasets:[{data:D.fonti_globali.map(f=>f.importo),backgroundColor:D.fonti_globali.map(f=>FC[f.fondo]||'#6366f1'),borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'55%'}});
document.querySelector('#t-fonti tbody').innerHTML=D.fonti_globali.map(f=>`<tr><td>${f.fondo}</td><td class="mo">${fmt(f.importo)}</td><td class="mo">${f.n_cup}</td><td><span class="pb"><span class="pf" style="width:${(f.importo/tB*100).toFixed(0)}%;background:${FC[f.fondo]||'#6366f1'}"></span></span>${(f.importo/tB*100).toFixed(1)}%</td></tr>`).join('');
}
if(D.fonti_missione&&D.fonti_missione.length){const miss=[...new Set(D.fonti_missione.map(f=>f.missione))].sort(),fondi=[...new Set(D.fonti_missione.map(f=>f.fondo))];
new Chart(document.getElementById('c-fm'),{type:'bar',data:{labels:miss,datasets:fondi.map(fd=>({label:fS(fd),data:miss.map(m=>{const r=D.fonti_missione.find(x=>x.missione===m&&x.fondo===fd);return r?r.importo:0}),backgroundColor:FC[fd]||'#6366f1',borderRadius:2}))},options:{responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true,grid:{display:false}},y:{stacked:true,ticks:{callback:v=>fM(v)},grid:{color:'#1e293b44'}}},plugins:{tooltip:ttCb}}});}
if(D.fonti_misura&&D.fonti_misura.length){const mis=[...new Set(D.fonti_misura.map(f=>f.misura))],fondi2=[...new Set(D.fonti_misura.map(f=>f.fondo))];
new Chart(document.getElementById('c-fmi'),{type:'bar',data:{labels:mis,datasets:fondi2.map(fd=>({label:fS(fd),data:mis.map(m=>{const r=D.fonti_misura.find(x=>x.misura===m&&x.fondo===fd);return r?r.importo:0}),backgroundColor:FC[fd]||'#6366f1',borderRadius:2}))},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',scales:{y:{stacked:true,grid:{display:false},ticks:{font:{size:9}}},x:{stacked:true,ticks:{callback:v=>fM(v)},grid:{color:'#1e293b44'}}},plugins:{tooltip:ttCb}}});}

// ‚ïê‚ïê‚ïê MISURE ‚ïê‚ïê‚ïê
if(D.misure&&D.misure.length){const mT=D.misure.filter(m=>m.budget_totale>0);
new Chart(document.getElementById('c-misb'),{type:'bar',data:{labels:mT.map(m=>m.misura),datasets:[
{label:'Budget',data:mT.map(m=>m.budget_totale),backgroundColor:'rgba(59,130,246,.4)',borderRadius:4},
{label:'Pagamenti',data:mT.map(m=>m.totale_pagamenti),backgroundColor:'rgba(16,185,129,.6)',borderRadius:4}
]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{callback:v=>fM(v)},grid:{color:'#1e293b44'}},x:{grid:{display:false},ticks:{maxRotation:45,font:{size:9}}}},plugins:{tooltip:ttCb}}});
new Chart(document.getElementById('c-misa'),{type:'bar',data:{labels:mT.map(m=>m.misura),datasets:[{label:'%',data:mT.map(m=>m.avanzamento_pct),backgroundColor:mT.map(m=>pC(m.avanzamento_pct)+'99'),borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',scales:{x:{max:100,ticks:{callback:v=>v+'%'},grid:{color:'#1e293b44'}},y:{grid:{display:false},ticks:{font:{size:10}}}},plugins:{legend:{display:false}}}});
}
if(D.iter_stato&&D.iter_stato.length){const iM=[...new Set(D.iter_stato.map(i=>i.misura))],sN=['COMPLETATA','IN_CORSO','IN_RITARDO','NON_AVVIATA','COMPLETATA_RITARDO'];
new Chart(document.getElementById('c-iter'),{type:'bar',data:{labels:iM,datasets:sN.map(s=>({label:s.replace(/_/g,' '),data:iM.map(m=>{const f=D.iter_stato.find(i=>i.misura===m&&i.stato===s);return f?f.n:0}),backgroundColor:SC[s],borderRadius:2}))},options:{responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true,ticks:{maxRotation:45,font:{size:9}},grid:{display:false}},y:{stacked:true,grid:{color:'#1e293b44'}}}}});}

// ‚ïê‚ïê‚ïê ESECUZIONE ‚ïê‚ïê‚ïê
if(D.esecuzione&&D.esecuzione.length){
const exS={};D.esecuzione.forEach(e=>{exS[e.stato]=(exS[e.stato]||0)+1;});const exK=Object.keys(exS);
new Chart(document.getElementById('c-ep'),{type:'doughnut',data:{labels:exK.map(s=>s.replace(/_/g,' ')+' ('+exS[s]+')'),datasets:[{data:exK.map(s=>exS[s]),backgroundColor:exK.map(s=>SC[s]||'#6366f1'),borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'55%'}});
const exM=[...new Set(D.esecuzione.map(e=>e.misura))],exN=['COMPLETATA','IN_CORSO','IN_RITARDO','NON_AVVIATA','COMPLETATA_RITARDO'];
new Chart(document.getElementById('c-em'),{type:'bar',data:{labels:exM,datasets:exN.map(s=>({label:s.replace(/_/g,' '),data:exM.map(m=>D.esecuzione.filter(e=>e.misura===m&&e.stato===s).length),backgroundColor:SC[s],borderRadius:2}))},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',scales:{x:{stacked:true,grid:{color:'#1e293b44'}},y:{stacked:true,grid:{display:false},ticks:{font:{size:9}}}}}});
exM.forEach(m=>{const o=document.createElement('option');o.value=m;o.textContent=m;document.getElementById('fe-mis').appendChild(o)});
let exD=[...D.esecuzione];
function rExec(d){document.querySelector('#t-exec tbody').innerHTML=d.map(e=>{const c=SC[e.stato]||'#94a3b8';return`<tr><td style="color:${c};font-weight:600">${(e.stato||'').replace(/_/g,' ')}</td><td class="mo" style="font-size:.6rem">${e.cup}</td><td>${e.misura}</td><td style="max-width:170px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${e.titolo_intervento||'‚Äî'}</td><td style="font-size:.68rem">${e.rup||'‚Äî'}</td><td class="mo">${e.data_inizio_eff||'‚Äî'}</td><td class="mo">${e.data_fine_prev||'‚Äî'}</td><td class="mo">${e.data_fine_eff||'‚Äî'}</td><td class="mo" style="color:${(e.ritardo_giorni||0)>0?'var(--red)':'var(--grn)'}">${e.ritardo_giorni!=null?e.ritardo_giorni:'‚Äî'}</td></tr>`;}).join('');}
function fExec(){const fm=document.getElementById('fe-mis').value,fs=document.getElementById('fe-st').value;let d=[...D.esecuzione];if(fm!=='all')d=d.filter(e=>e.misura===fm);if(fs!=='all')d=d.filter(e=>e.stato===fs);exD=d;rExec(d);}
document.getElementById('fe-mis').addEventListener('change',fExec);document.getElementById('fe-st').addEventListener('change',fExec);
rExec(exD);mkSort('t-exec',()=>exD,d=>{exD=d;rExec(d)});
}

// ‚ïê‚ïê‚ïê ALERT ‚ïê‚ïê‚ïê
const crit=D.progetti.filter(p=>p.alert_level==='CRITICO'),att=D.progetti.filter(p=>p.alert_level==='ATTENZIONE');
let abh='';if(crit.length)abh+=`<div class="ab red">üî¥ <strong>${crit.length} CUP critici</strong> ‚Äî In ritardo con avanzamento basso</div>`;
if(att.length)abh+=`<div class="ab amber">üü° <strong>${att.length} CUP in attenzione</strong> ‚Äî Fasi in ritardo o avanzamento molto basso</div>`;
document.getElementById('ab').innerHTML=abh;
if(D.alert_per_misura&&D.alert_per_misura.length)
new Chart(document.getElementById('c-am'),{type:'bar',data:{labels:D.alert_per_misura.map(a=>a.misura),datasets:[
{label:'Critici',data:D.alert_per_misura.map(a=>a.critici),backgroundColor:'rgba(239,68,68,.7)',borderRadius:2},
{label:'Attenzione',data:D.alert_per_misura.map(a=>a.attenzione),backgroundColor:'rgba(245,158,11,.7)',borderRadius:2},
{label:'OK',data:D.alert_per_misura.map(a=>a.ok),backgroundColor:'rgba(16,185,129,.5)',borderRadius:2}
]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true,ticks:{maxRotation:45,font:{size:9}},grid:{display:false}},y:{stacked:true,grid:{color:'#1e293b44'}}}}});
let alD=[...crit,...att].sort((a,b)=>(a.alert_level==='CRITICO'?0:1)-(b.alert_level==='CRITICO'?0:1)||(b.budget||0)-(a.budget||0));
function rAlert(d){document.querySelector('#t-alert tbody').innerHTML=d.map(p=>`<tr><td><span class="ad ${p.alert_level}"></span>${p.alert_level}</td><td class="mo" style="font-size:.58rem">${p.cup}</td><td>${p.misura}</td><td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.titolo_intervento||'‚Äî'}</td><td class="mo">${fM(p.budget)}</td><td><span class="pb"><span class="pf" style="width:${Math.min(p.avanzamento_pct||0,100)}%;background:${pC(p.avanzamento_pct||0)}"></span></span>${pct(p.avanzamento_pct)}</td><td class="mo">${p.esecuzione_fine_prev||'‚Äî'}</td></tr>`).join('');}
rAlert(alD);mkSort('t-alert',()=>alD,d=>{alD=d;rAlert(d)});

// ‚ïê‚ïê‚ïê TREND ‚ïê‚ïê‚ïê
let trC=null;
if(D.pagamenti_cup&&D.pagamenti_cup.length){
[...new Set(D.pagamenti_cup.map(p=>p.misura))].sort().forEach(m=>{const o=document.createElement('option');o.value=m;o.textContent=m;document.getElementById('tr-mis').appendChild(o)});
document.getElementById('tr-mis').addEventListener('change',function(){const m=this.value,cs=document.getElementById('tr-cup');cs.innerHTML='<option value="">‚Äî Tutti i CUP ‚Äî</option>';if(!m)return;
[...new Set(D.pagamenti_cup.filter(p=>p.misura===m).map(p=>p.cup))].forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;cs.appendChild(o)});rTrend(m,'');});
document.getElementById('tr-cup').addEventListener('change',function(){const m=document.getElementById('tr-mis').value;if(m)rTrend(m,this.value);});
function rTrend(mis,cup){let rows=D.pagamenti_cup.filter(p=>p.misura===mis);if(cup)rows=rows.filter(p=>p.cup===cup);
const tri=[...new Set(rows.map(r=>r.trimestre))].sort();let ds;
if(cup){ds=[{label:cup,data:tri.map(t=>{const r=rows.find(x=>x.trimestre===t);return r?r.importo:0}),backgroundColor:'rgba(59,130,246,.6)',borderRadius:4}];document.getElementById('tr-title').textContent='Pagamenti: '+mis+' ‚Äî '+cup;}
else{const cups=[...new Set(rows.map(r=>r.cup))];ds=cups.map((c,i)=>({label:c,data:tri.map(t=>{const r=rows.find(x=>x.cup===c&&x.trimestre===t);return r?r.importo:0}),backgroundColor:mC[i%mC.length],borderRadius:2}));document.getElementById('tr-title').textContent='Pagamenti per CUP: '+mis;}
if(trC)trC.destroy();trC=new Chart(document.getElementById('c-tr'),{type:'bar',data:{labels:tri,datasets:ds},options:{responsive:true,maintainAspectRatio:false,scales:{x:{stacked:!cup,grid:{display:false}},y:{stacked:!cup,ticks:{callback:v=>fM(v)},grid:{color:'#1e293b44'}}},plugins:{tooltip:ttCb}}});
}}

// ‚ïê‚ïê‚ïê INDICATORI ‚ïê‚ïê‚ïê
if(D.indicatori&&D.indicatori.length){
const iF=D.indicatori.filter(i=>i.tot_programmato>0).slice(0,40);
if(iF.length)new Chart(document.getElementById('c-ind'),{type:'bar',data:{labels:iF.map(i=>i.indicatore.substring(0,40)+(i.indicatore.length>40?'...':'')),datasets:[
{label:'Programmato',data:iF.map(i=>i.tot_programmato),backgroundColor:'rgba(59,130,246,.4)',borderRadius:4},
{label:'Realizzato',data:iF.map(i=>i.tot_realizzato),backgroundColor:'rgba(16,185,129,.6)',borderRadius:4}
]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',scales:{x:{type:'logarithmic',grid:{color:'#1e293b44'},ticks:{callback:v=>v>=1e6?(v/1e6).toFixed(0)+'M':v>=1e3?(v/1e3).toFixed(0)+'K':v}},y:{grid:{display:false},ticks:{font:{size:9}}}}}});
let indD=[...D.indicatori];
function rInd(d){document.querySelector('#t-ind tbody').innerHTML=d.map(i=>{const low=i.pct_raggiungimento!=null&&i.pct_raggiungimento<50;return`<tr style="${low?'background:rgba(239,68,68,.08)':''}"><td>${i.misura||'‚Äî'}</td><td style="max-width:260px">${i.indicatore}</td><td>${i.unita_misura||'‚Äî'}</td><td class="mo">${i.tot_programmato!=null?Number(i.tot_programmato).toLocaleString('it-IT'):'‚Äî'}</td><td class="mo">${i.tot_realizzato!=null?Number(i.tot_realizzato).toLocaleString('it-IT'):'‚Äî'}</td><td><span class="pb"><span class="pf" style="width:${Math.min(i.pct_raggiungimento||0,100)}%;background:${pC(i.pct_raggiungimento||0)}"></span></span>${pct(i.pct_raggiungimento)}${low?' ‚ö†Ô∏è':''}</td></tr>`;}).join('');}
rInd(indD);mkSort('t-ind',()=>indD,d=>{indD=d;rInd(d)});
}

// ‚ïê‚ïê‚ïê MAPPA ‚ïê‚ïê‚ïê
let map;
const CC={'CAMPOBASSO':[41.5603,14.6628],'ISERNIA':[41.5960,14.2301],'TERMOLI':[42.0025,14.9924],'BOJANO':[41.4833,14.4667],'LARINO':[41.8,14.9167],'VENAFRO':[41.4833,14.05],'AGNONE':[41.8167,14.3667],'TRIVENTO':[41.7833,14.55],'RICCIA':[41.4833,14.8333],'GUGLIONESI':[41.9167,14.9167],'CAMPOMARINO':[41.95,15.0333],'MONTENERO DI BISACCIA':[41.95,14.7833],'SANTA CROCE DI MAGLIANO':[41.7167,14.9833],'PETTORANELLO':[41.5667,14.2833],'FROSOLONE':[41.6,14.45],'CASTELPETROSO':[41.55,14.35],'FORNELLI':[41.6167,14.1333],'COLLI AL VOLTURNO':[41.6167,14.1],'MONTERODUNI':[41.5167,14.1667],'CERRO AL VOLTURNO':[41.65,14.1],'CAPRACOTTA':[41.8333,14.2667],'PESCHE':[41.6167,14.2667],'SEPINO':[41.4,14.4833],'BARANELLO':[41.5333,14.55],'CAMPOCHIARO':[41.45,14.5167],'FERRAZZANO':[41.5333,14.6667],'ORATINO':[41.5833,14.5833],'CASTROPIGNANO':[41.6167,14.5667],'SAN MARTINO IN PENSILIS':[41.8667,15.0167],'PORTOCANNONE':[41.9167,15.0333],'PALATA':[41.8833,14.7833],'TAVENNA':[41.9167,14.75],'GAMBATESA':[41.5,14.9167],'JELSI':[41.5167,14.8],'TORO':[41.5667,14.7667],'BONEFRO':[41.7,14.9333],'COLLETORTO':[41.6667,14.9667],'ROTELLO':[41.75,15.0],'URURI':[41.8167,15.0],'VINCHIATURO':[41.4833,14.5833],'MACCHIAGODENA':[41.5667,14.4333],'SAN GIULIANO DEL SANNIO':[41.4667,14.6333],'DURONIA':[41.6667,14.4667],'MOLISE':[41.6333,14.35],'BAGNOLI DEL TRIGNO':[41.6933,14.4533],'FOSSALTO':[41.6667,14.5333],'LIMOSANO':[41.6333,14.6],'MONTAGANO':[41.65,14.6667],'RIPALIMOSANI':[41.5333,14.7],'LUPARA':[41.7667,14.7333],'MORRONE DEL SANNIO':[41.7167,14.7833],'CASACALENDA':[41.7333,14.85],'PROVVIDENTI':[41.7167,14.8167],'MONTEMITRO':[41.8667,14.65],'ACQUAVIVA COLLECROCE':[41.8667,14.7167],'SAN FELICE DEL MOLISE':[41.8833,14.6833],'MAFALDA':[41.95,14.7167],'MONTECILFONE':[41.9167,14.8333],'PIETRACATELLA':[41.5833,14.8833],'TUFARA':[41.4833,14.95],'CERCEMAGGIORE':[41.4667,14.7167],'CERCEPICCOLA':[41.4667,14.6833],'SAN POLO MATESE':[41.4333,14.5333],'CANTALUPO NEL SANNIO':[41.5167,14.3833]};
function initMap(){if(map)return;map=L.map('map').setView([41.56,14.46],9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OSM'}).addTo(map);
fetch('https://raw.githubusercontent.com/openpolis/geojson-italy/master/geojson/limits/IT/reg/14.json').then(r=>r.ok?r.json():null).then(g=>{if(g)L.geoJSON(g,{style:{fillColor:'#3b82f6',fillOpacity:.03,color:'#3b82f6',weight:2,opacity:.4}}).addTo(map)}).catch(()=>{});
rMap('all');}
function rMap(filter){if(!map)return;map.eachLayer(l=>{if(l instanceof L.CircleMarker)map.removeLayer(l)});
const lc={},rw=[];
D.progetti.forEach(p=>{if(filter==='CRITICO'&&p.alert_level!=='CRITICO')return;
const ti=(p.titolo_intervento||'').toUpperCase();let matched=false;
for(const[com,co]of Object.entries(CC)){if(ti.includes(com)){const k=com;if(!lc[k])lc[k]={co,n:0,b:0};lc[k].n++;lc[k].b+=(p.budget||0);matched=true;break;}}
if(!matched)rw.push(p);});
Object.entries(lc).forEach(([com,d])=>{const r=Math.max(6,Math.min(25,4+Math.sqrt(d.n)*4));
L.circleMarker(d.co,{radius:r,fillColor:'#3b82f6',color:'#fff',weight:1.5,opacity:.9,fillOpacity:.7}).bindPopup(`<b>${com}</b><br>${d.n} interventi<br>Budget: ${fM(d.b)}`).addTo(map);});
if(rw.length>3)L.circleMarker([41.56,14.46],{radius:45,fillColor:'#8b5cf6',color:'#8b5cf6',weight:0,fillOpacity:.07}).bindPopup(`<b>Tutta la regione / non localizzati</b><br>${rw.length} interventi<br>Budget: ${fM(rw.reduce((s,p)=>s+(p.budget||0),0))}`).addTo(map);
}
document.querySelectorAll('[data-mf]').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('[data-mf]').forEach(x=>x.classList.remove('active'));b.classList.add('active');rMap(b.dataset.mf);}));

// ‚ïê‚ïê‚ïê RUP ‚ïê‚ïê‚ïê
let ruD=[...(D.rup_stats||[])];
function rRup(d){document.querySelector('#t-rup tbody').innerHTML=d.map(r=>`<tr><td><strong>${r.rup}</strong></td><td class="mo">${r.n_cup}</td><td class="mo">${fM(r.budget)}</td><td class="mo">${fM(r.pagamenti)}</td><td><span class="pb"><span class="pf" style="width:${Math.min(r.avanz||0,100)}%;background:${pC(r.avanz||0)}"></span></span>${pct(r.avanz)}</td><td>${r.n_critici>0?'<span style="color:var(--red)">'+r.n_critici+'</span>':'0'}</td></tr>`).join('');}
rRup(ruD);mkSort('t-rup',()=>ruD,d=>{ruD=d;rRup(d)});

// ‚ïê‚ïê‚ïê PROGETTI ‚ïê‚ïê‚ïê
let pD=[...D.progetti],pSC='budget',pSD=-1;
[...new Set(D.progetti.map(p=>p.missione).filter(Boolean))].forEach(m=>{const o=document.createElement('option');o.value=m;o.textContent=m;document.getElementById('f-miss').appendChild(o)});
[...new Set(D.progetti.map(p=>p.rup).filter(Boolean))].sort().forEach(r=>{const o=document.createElement('option');o.value=r;o.textContent=r;document.getElementById('f-rup').appendChild(o)});
function rProj(d){document.querySelector('#t-proj tbody').innerHTML=d.map(p=>`<tr><td><span class="ad ${p.alert_level||'OK'}"></span></td><td class="mo" style="font-size:.58rem">${p.cup}</td><td>${p.misura}</td><td style="max-width:170px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.titolo_intervento||'‚Äî'}</td><td style="font-size:.68rem">${p.rup||'‚Äî'}</td><td class="mo">${fM(p.budget)}</td><td class="mo">${fM(p.pagato)}</td><td><span class="pb"><span class="pf" style="width:${Math.min(p.avanzamento_pct||0,100)}%;background:${pC(p.avanzamento_pct||0)}"></span></span>${pct(p.avanzamento_pct)}</td><td style="font-size:.63rem;color:${SC[p.esecuzione_stato]||'var(--dim)'}">${(p.esecuzione_stato||'‚Äî').replace(/_/g,' ')}</td><td style="font-size:.68rem">${p.area||'‚Äî'}</td></tr>`).join('');}
function fProj(){let f=pD.filter(p=>{const fm=document.getElementById('f-miss').value,fr=document.getElementById('f-rup').value,fa=document.getElementById('f-al').value,s=document.getElementById('src').value.toLowerCase();
if(fm!=='all'&&p.missione!==fm)return false;if(fr!=='all'&&p.rup!==fr)return false;if(fa!=='all'&&p.alert_level!==fa)return false;if(s&&!JSON.stringify(p).toLowerCase().includes(s))return false;return true;});
f.sort((a,b)=>{let va=a[pSC],vb=b[pSC];if(va==null)va='';if(vb==null)vb='';if(typeof va==='string'&&typeof vb==='string')return pSD*va.localeCompare(vb);return pSD*((+va||0)-(+vb||0));});rProj(f);}
document.getElementById('src').addEventListener('input',fProj);document.getElementById('f-miss').addEventListener('change',fProj);
document.getElementById('f-rup').addEventListener('change',fProj);document.getElementById('f-al').addEventListener('change',fProj);
document.querySelectorAll('#t-proj th[data-s]').forEach(th=>th.addEventListener('click',()=>{
document.querySelectorAll('#t-proj th').forEach(t=>t.classList.remove('sa','sd'));
if(pSC===th.dataset.s)pSD*=-1;else{pSC=th.dataset.s;pSD=-1;}th.classList.add(pSD===1?'sa':'sd');fProj();}));
fProj();
</script>
</body></html>
